<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tutorial &mdash; Ragger 1.1.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="_static/sphinxcontrib-images/LightBox2/lightbox2/dist/css/lightbox.css" type="text/css" />
    <link rel="shortcut icon" href="_static/ragger.png"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script src="_static/clipboard.min.js"></script>
        <script src="_static/copybutton.js"></script>
        <script src="_static/sphinxcontrib-images/LightBox2/lightbox2/dist/js/lightbox-plus-jquery.min.js"></script>
        <script src="_static/sphinxcontrib-images/LightBox2/lightbox2-customize/jquery-noconflict.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Architecture" href="architecture.html" />
    <link rel="prev" title="Rationale" href="rationale.html" />
    <link href="_static/layout.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Ragger
          </a>
              <div class="version">
                1.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">How is this doc structured:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="rationale.html">Rationale</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#ragger-installation"><code class="docutils literal notranslate"><span class="pre">Ragger</span></code> installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#first-backend-instantiation">First backend instantiation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-speculosbackend">The <code class="docutils literal notranslate"><span class="pre">SpeculosBackend</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#backend-as-a-fixture">Backend as a fixture</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#generalization">Generalization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#to-other-firmwares">To other firmwares</a></li>
<li class="toctree-l3"><a class="reference internal" href="#to-other-backends">To other backends</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#abstracting-the-interactions">Abstracting the interactions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#fatstacks">Fatstacks</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#layouts">Layouts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#use-cases">Use cases</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-fullscreen-class">The <code class="docutils literal notranslate"><span class="pre">FullScreen</span></code> class</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="source.html">Code documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Ragger</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Tutorial</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/tutorial.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="tutorial">
<span id="id1"></span><h1>Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this heading"></a></h1>
<p>In this tutorial, we are going to develop glue code to leverage the capabilities
of <code class="docutils literal notranslate"><span class="pre">Ragger</span></code> in order to write tests which are able to run either on
<a class="reference internal" href="glossary.html#term-Speculos"><span class="xref std std-term">Speculos</span></a> or on a physical device.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#ragger-installation" id="id6"><code class="docutils literal notranslate"><span class="pre">Ragger</span></code> installation</a></p></li>
<li><p><a class="reference internal" href="#first-backend-instantiation" id="id7">First backend instantiation</a></p>
<ul>
<li><p><a class="reference internal" href="#the-speculosbackend" id="id8">The <code class="docutils literal notranslate"><span class="pre">SpeculosBackend</span></code></a></p></li>
<li><p><a class="reference internal" href="#backend-as-a-fixture" id="id9">Backend as a fixture</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#generalization" id="id10">Generalization</a></p>
<ul>
<li><p><a class="reference internal" href="#to-other-firmwares" id="id11">To other firmwares</a></p></li>
<li><p><a class="reference internal" href="#to-other-backends" id="id12">To other backends</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#abstracting-the-interactions" id="id13">Abstracting the interactions</a></p>
<ul>
<li><p><a class="reference internal" href="#fatstacks" id="id14">Fatstacks</a></p>
<ul>
<li><p><a class="reference internal" href="#layouts" id="id15">Layouts</a></p></li>
<li><p><a class="reference internal" href="#use-cases" id="id16">Use cases</a></p></li>
<li><p><a class="reference internal" href="#the-fullscreen-class" id="id17">The <code class="docutils literal notranslate"><span class="pre">FullScreen</span></code> class</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="ragger-installation">
<h2><code class="docutils literal notranslate"><span class="pre">Ragger</span></code> installation<a class="headerlink" href="#ragger-installation" title="Permalink to this heading"></a></h2>
<p>First step of all is the installation of <code class="docutils literal notranslate"><span class="pre">Ragger</span></code>. At first, we are going to
test it with <a class="reference internal" href="glossary.html#term-Speculos"><span class="xref std std-term">Speculos</span></a>, so we are going to install <code class="docutils literal notranslate"><span class="pre">Ragger</span></code> with Speculos
dependencies:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--extra-index-url<span class="w"> </span>https://test.pypi.org/simple/<span class="w"> </span>ragger<span class="o">[</span>speculos<span class="o">]</span>
</pre></div>
</div>
<p>Some explanation on arguments:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--extra-index-url</span> <span class="pre">https://test.pypi.org/simple/</span></code> is necessary to get the
latest version of <code class="docutils literal notranslate"><span class="pre">Ragger</span></code>, as it is currently not deployed on the
stable <code class="docutils literal notranslate"><span class="pre">pypi</span></code> repositories.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ragger[speculos]</span></code> means than Speculos and its dependencies will also
be installed. <code class="docutils literal notranslate"><span class="pre">Ragger</span></code> tries to uncouple its dependencies so that only
what is needed is installed.
All the extras can be seen
<a class="reference external" href="https://github.com/LedgerHQ/ragger/blob/develop/setup.cfg#L36-L100">in the setup.cfg</a>
file.</p></li>
</ul>
</div>
<div class="section" id="first-backend-instantiation">
<h2>First backend instantiation<a class="headerlink" href="#first-backend-instantiation" title="Permalink to this heading"></a></h2>
<div class="section" id="the-speculosbackend">
<h3>The <code class="docutils literal notranslate"><span class="pre">SpeculosBackend</span></code><a class="headerlink" href="#the-speculosbackend" title="Permalink to this heading"></a></h3>
<p>The <a class="reference internal" href="source.html#ragger.backend.BackendInterface" title="ragger.backend.BackendInterface"><code class="xref py py-class docutils literal notranslate"><span class="pre">BackendInterface</span></code></a> really only
needs a <a class="reference internal" href="source.html#ragger.firmware.Firmware" title="ragger.firmware.Firmware"><code class="xref py py-class docutils literal notranslate"><span class="pre">Firmware</span></code></a> - declaring the type of
Ledger cold wallet to run the <a class="reference internal" href="glossary.html#term-Application"><span class="xref std std-term">application</span></a> on, and the version of the
given <a class="reference internal" href="glossary.html#term-SDK"><span class="xref std std-term">SDK</span></a>, to be instantiated.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kn">from</span> <span class="nn">ragger.firmware</span> <span class="kn">import</span> <span class="n">Firmware</span>
<span class="linenos">2</span><span class="kn">from</span> <span class="nn">ragger.backend</span> <span class="kn">import</span> <span class="n">BackendInterface</span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="n">backend</span> <span class="o">=</span> <span class="n">BackendInterface</span><span class="p">(</span><span class="n">Firmware</span><span class="p">(</span><span class="s2">&quot;nanos&quot;</span><span class="p">,</span> <span class="s2">&quot;2.1.0&quot;</span><span class="p">))</span>  <span class="c1"># this won&#39;t work, as it is an abstract interface</span>
</pre></div>
</div>
<p>However, as we us Speculos which is going to start the <a class="reference internal" href="glossary.html#term-Application"><span class="xref std std-term">application</span></a> inside an emulator,
we need to provide the application ELF file as an argument:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kn">from</span> <span class="nn">ragger.firmware</span> <span class="kn">import</span> <span class="n">Firmware</span>
<span class="linenos">2</span><span class="kn">from</span> <span class="nn">ragger.backend</span> <span class="kn">import</span> <span class="n">SpeculosBackend</span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="n">APPLICATION_ELF</span> <span class="o">=</span> <span class="s2">&quot;path/to/app.elf&quot;</span>
<span class="linenos">5</span>
<span class="linenos">6</span><span class="n">backend</span> <span class="o">=</span> <span class="n">SpeculosBackend</span><span class="p">(</span><span class="n">APPLICATION_ELF</span><span class="p">,</span> <span class="n">Firmware</span><span class="p">(</span><span class="s2">&quot;nanos&quot;</span><span class="p">,</span> <span class="s2">&quot;2.1.0&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>And that’s it, you have a working backend! Although in the case of Speculos,
the emulator won’t start immediately. You need to use a <code class="docutils literal notranslate"><span class="pre">with</span></code> statement
to start it and begin to exchange APDUs or other events with you application.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">with</span> <span class="n">backend</span><span class="p">:</span>
<span class="linenos">2</span>    <span class="n">backend</span><span class="o">.</span><span class="n">exchange</span><span class="p">(</span><span class="n">cla</span><span class="o">=</span><span class="mh">0xE0</span><span class="p">,</span> <span class="n">ins</span><span class="o">=</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&quot;DEADBEEF&quot;</span><span class="p">))</span>
<span class="linenos">3</span>    <span class="n">backend</span><span class="o">.</span><span class="n">right_click</span><span class="p">()</span>
</pre></div>
</div>
<p>This syntax will ensure that the backends properly clean what needs cleaning
once the communication is done. For Speculos, this mean stopping the whole
emulator, for other backend it could be as simple as closing a socket.</p>
</div>
<div class="section" id="backend-as-a-fixture">
<h3>Backend as a fixture<a class="headerlink" href="#backend-as-a-fixture" title="Permalink to this heading"></a></h3>
<p>From this, we are not far away from writing a <a class="reference internal" href="glossary.html#term-Pytest"><span class="xref std std-term">Pytest</span></a> fixture, wich could
take place in a <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> file, and used in a <code class="docutils literal notranslate"><span class="pre">test_something.py</span></code> file:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">conftest.py</span><a class="headerlink" href="#id2" title="Permalink to this code"></a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">pytest</span> <span class="kn">import</span> <span class="n">fixture</span>
<span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">ragger.firmware</span> <span class="kn">import</span> <span class="n">Firmware</span>
<span class="linenos"> 3</span><span class="kn">from</span> <span class="nn">ragger.backend</span> <span class="kn">import</span> <span class="n">SpeculosBackend</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="n">APPLICATION_ELF</span> <span class="o">=</span> <span class="s2">&quot;path/to/application.elf&quot;</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="nd">@fixture</span>
<span class="linenos"> 8</span><span class="k">def</span> <span class="nf">backend</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">SpeculosBackend</span><span class="p">:</span>
<span class="linenos"> 9</span>    <span class="n">backend</span> <span class="o">=</span> <span class="n">SpeculosBackend</span><span class="p">(</span><span class="n">APPLICATION_ELF</span><span class="p">,</span> <span class="n">Firmware</span><span class="p">(</span><span class="s2">&quot;nanos&quot;</span><span class="p">,</span> <span class="s2">&quot;2.1.0&quot;</span><span class="p">))</span>
<span class="linenos">10</span>    <span class="k">with</span> <span class="n">backend</span><span class="p">:</span>
<span class="linenos">11</span>        <span class="k">yield</span> <span class="n">backend</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">test_something.py</span><a class="headerlink" href="#id3" title="Permalink to this code"></a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">def</span> <span class="nf">test_something</span><span class="p">(</span><span class="n">backend</span><span class="p">):</span>
<span class="linenos">2</span>    <span class="n">backend</span><span class="o">.</span><span class="n">exchange</span><span class="p">(</span><span class="n">cla</span><span class="o">=</span><span class="mh">0xE0</span><span class="p">,</span> <span class="n">ins</span><span class="o">=</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&quot;DEADBEEF&quot;</span><span class="p">))</span>
<span class="linenos">3</span>    <span class="n">backend</span><span class="o">.</span><span class="n">right_click</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>This code can then be trigger with <code class="docutils literal notranslate"><span class="pre">Pytest</span></code> like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>-v<span class="w"> </span>test_something.py

<span class="o">===============================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">===============================</span>
collected<span class="w"> </span><span class="m">1</span><span class="w"> </span>item

test_something.py::test_something<span class="w"> </span>PASSED<span class="w">                                     </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">================================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.41s<span class="w"> </span><span class="o">================================</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="generalization">
<h2>Generalization<a class="headerlink" href="#generalization" title="Permalink to this heading"></a></h2>
<div class="section" id="to-other-firmwares">
<h3>To other firmwares<a class="headerlink" href="#to-other-firmwares" title="Permalink to this heading"></a></h3>
<p>When testing an application, it sounds logical to test not only a specific
<a class="reference internal" href="glossary.html#term-Firmware"><span class="xref std std-term">Firmware</span></a>, but all supported ones. The common practice is to test
on the latest version of all Firmware (NanoS, NanoS+, NanoX). So we can declare
a list of those:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kn">from</span> <span class="nn">ragger.firmware</span> <span class="kn">import</span> <span class="n">Firmware</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="n">FIRMWARES</span> <span class="o">=</span> <span class="p">[</span><span class="n">Firmware</span><span class="p">(</span><span class="s1">&#39;nanos&#39;</span><span class="p">,</span> <span class="s1">&#39;2.1&#39;</span><span class="p">),</span>
<span class="linenos">4</span>             <span class="n">Firmware</span><span class="p">(</span><span class="s1">&#39;nanox&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.2&#39;</span><span class="p">),</span>
<span class="linenos">5</span>             <span class="n">Firmware</span><span class="p">(</span><span class="s1">&#39;nanosp&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.3&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<p>Then we can override the
<a class="reference external" href="https://docs.pytest.org/en/7.2.x/how-to/parametrize.html#pytest-generate-tests">pytest_generate_tests</a>
function to automatically create a fixture (let’s call it <code class="docutils literal notranslate"><span class="pre">firmware</span></code>), which
will parametrize every test using this fixture and trigger then with each
declared firmware version:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">def</span> <span class="nf">pytest_generate_tests</span><span class="p">(</span><span class="n">metafunc</span><span class="p">):</span>
<span class="linenos">2</span><span class="n">fw_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="linenos">3</span><span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="linenos">4</span>    <span class="k">if</span> <span class="s2">&quot;firmware&quot;</span> <span class="ow">in</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">fixturenames</span><span class="p">:</span>
<span class="linenos">5</span>        <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">FIRMWARES</span><span class="p">:</span>
<span class="linenos">6</span>            <span class="n">fw_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>
<span class="linenos">7</span>            <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw</span><span class="o">.</span><span class="n">device</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">fw</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
<span class="linenos">8</span>        <span class="n">metafunc</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;firmware&quot;</span><span class="p">,</span> <span class="n">fw_list</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">)</span>
</pre></div>
</div>
<p>Now let’s modify our previous <code class="docutils literal notranslate"><span class="pre">backend</span></code> fixture to use this <code class="docutils literal notranslate"><span class="pre">firmware</span></code>
fixture:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="nd">@fixture</span>
<span class="linenos">2</span><span class="k">def</span> <span class="nf">backend</span><span class="p">(</span><span class="n">firmware</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpeculosBackend</span><span class="p">:</span>
<span class="linenos">3</span>    <span class="n">backend</span> <span class="o">=</span> <span class="n">SpeculosBackend</span><span class="p">(</span><span class="n">APPLICATION_ELF</span><span class="p">,</span> <span class="n">firmware</span><span class="p">)</span>
<span class="linenos">4</span>    <span class="k">with</span> <span class="n">backend</span><span class="p">:</span>
<span class="linenos">5</span>        <span class="k">yield</span> <span class="n">backend</span>
</pre></div>
</div>
<p>Now this <code class="docutils literal notranslate"><span class="pre">backend</span></code> fixture is parametrized, and will trigger 3 times, with
successively <code class="docutils literal notranslate"><span class="pre">firmware</span> <span class="pre">=</span> <span class="pre">Firmware('nanos',</span> <span class="pre">'2.1')</span></code>,
<code class="docutils literal notranslate"><span class="pre">firmware</span> <span class="pre">=</span> <span class="pre">Firmware('nanox',</span> <span class="pre">'2.0.2')</span></code> and
<code class="docutils literal notranslate"><span class="pre">firmware</span> <span class="pre">=</span> <span class="pre">Firmware('nanosp',</span> <span class="pre">'1.0.3')</span></code>. The test will also be triggered 3
times, with each time a <code class="docutils literal notranslate"><span class="pre">backend</span></code> configured with a different application.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The tests won’t pass, because they may be started with every SDK versions,
but the application ELF is not parametrized yet, and is still compiled for
only one SDK type and version!</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The application ELFs, hence the ELF file path has to be parametrized.</p>
</div>
<p>Thankfully, <code class="docutils literal notranslate"><span class="pre">Ragger</span></code> provides a
<a class="reference internal" href="source.html#ragger.utils.misc.app_path_from_app_name" title="ragger.utils.misc.app_path_from_app_name"><code class="xref py py-func docutils literal notranslate"><span class="pre">app_path_from_app_name</span></code></a>
function which infers an application name ELF given its name and the firmware
name.</p>
<p>So, given you have a directory <code class="docutils literal notranslate"><span class="pre">APPS_DIRECTORY</span></code> where you stored all your
application ELFs, and they are all named as <code class="docutils literal notranslate"><span class="pre">app_nanos.elf</span></code>,
<code class="docutils literal notranslate"><span class="pre">app_nanosp.elf</span></code>, <code class="docutils literal notranslate"><span class="pre">app_nanox.elf</span></code>, this code will deduce their proper
name and location:</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">conftest.py</span><a class="headerlink" href="#id4" title="Permalink to this code"></a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">pytest</span> <span class="kn">import</span> <span class="n">fixture</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kn">from</span> <span class="nn">ragger.firmware</span> <span class="kn">import</span> <span class="n">Firmware</span>
<span class="linenos"> 5</span><span class="kn">from</span> <span class="nn">ragger.backend</span> <span class="kn">import</span> <span class="n">SpeculosBackend</span>
<span class="linenos"> 6</span><span class="kn">from</span> <span class="nn">ragger.utils</span> <span class="kn">import</span> <span class="n">app_path_from_app_name</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="n">APPS_DIRECTORY</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;path/to/&quot;</span><span class="p">)</span>
<span class="linenos"> 9</span><span class="n">APP_NAME</span> <span class="o">=</span> <span class="s2">&quot;app&quot;</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="n">FIRMWARES</span> <span class="o">=</span> <span class="p">[</span><span class="n">Firmware</span><span class="p">(</span><span class="s1">&#39;nanos&#39;</span><span class="p">,</span> <span class="s1">&#39;2.1&#39;</span><span class="p">),</span>
<span class="linenos">12</span>             <span class="n">Firmware</span><span class="p">(</span><span class="s1">&#39;nanox&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.2&#39;</span><span class="p">),</span>
<span class="linenos">13</span>             <span class="n">Firmware</span><span class="p">(</span><span class="s1">&#39;nanosp&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.3&#39;</span><span class="p">)]</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="k">def</span> <span class="nf">pytest_generate_tests</span><span class="p">(</span><span class="n">metafunc</span><span class="p">):</span>
<span class="linenos">16</span>    <span class="n">fw_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="linenos">17</span>    <span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="linenos">18</span>    <span class="k">if</span> <span class="s2">&quot;firmware&quot;</span> <span class="ow">in</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">fixturenames</span><span class="p">:</span>
<span class="linenos">19</span>        <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">FIRMWARES</span><span class="p">:</span>
<span class="linenos">20</span>            <span class="n">fw_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>
<span class="linenos">21</span>            <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw</span><span class="o">.</span><span class="n">device</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">fw</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
<span class="linenos">22</span>        <span class="n">metafunc</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;firmware&quot;</span><span class="p">,</span> <span class="n">fw_list</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">)</span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="nd">@fixture</span>
<span class="linenos">25</span><span class="k">def</span> <span class="nf">backend</span><span class="p">(</span><span class="n">firmware</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpeculosBackend</span><span class="p">:</span>
<span class="linenos">26</span>    <span class="n">app_location</span> <span class="o">=</span> <span class="n">app_path_from_app_name</span><span class="p">(</span><span class="n">APPS_DIRECTORY</span><span class="p">,</span> <span class="n">APP_NAME</span><span class="p">,</span> <span class="n">firmware</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="linenos">27</span>    <span class="n">backend</span> <span class="o">=</span> <span class="n">SpeculosBackend</span><span class="p">(</span><span class="n">app_location</span><span class="p">,</span> <span class="n">firmware</span><span class="p">)</span>
<span class="linenos">28</span>    <span class="k">with</span> <span class="n">backend</span><span class="p">:</span>
<span class="linenos">29</span>        <span class="k">yield</span> <span class="n">backend</span>
</pre></div>
</div>
</div>
<p>And with this, all test should pass gracefully.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pytest<span class="w"> </span>-v<span class="w"> </span><span class="nv">test_something</span>

<span class="o">===============================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">===============================</span>
collected<span class="w"> </span><span class="m">3</span><span class="w"> </span>items

test_something.py::test_something<span class="o">[</span>nanos<span class="w"> </span><span class="m">2</span>.1<span class="o">]</span><span class="w"> </span>PASSED<span class="w">                          </span><span class="o">[</span><span class="w"> </span><span class="m">33</span>%<span class="o">]</span>
test_something.py::test_something<span class="o">[</span>nanox<span class="w"> </span><span class="m">2</span>.0.2<span class="o">]</span><span class="w"> </span>PASSED<span class="w">                        </span><span class="o">[</span><span class="w"> </span><span class="m">66</span>%<span class="o">]</span>
test_something.py::test_something<span class="o">[</span>nanosp<span class="w"> </span><span class="m">1</span>.0.3<span class="o">]</span><span class="w"> </span>PASSED<span class="w">                       </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">================================</span><span class="w"> </span><span class="m">3</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span>.90s<span class="w"> </span><span class="o">================================</span>
</pre></div>
</div>
</div>
<div class="section" id="to-other-backends">
<h3>To other backends<a class="headerlink" href="#to-other-backends" title="Permalink to this heading"></a></h3>
<p>So far only Speculos was used as a backend. Let’s see how to connect other ones.</p>
<p>Other backends are simpler the Speculos, because they do not manage the
application directly. Indeed, as Speculos embeds an emulator, the application
ELF file must be passed as an argument (and parametrized, …).</p>
<p>Other backends do not need this. They assume the application is already up and
running somewhere, and will only try to connect on it when the time comes.</p>
<p>We need however the capability to decide which backend will be used when running
the test. Let’s declare a <code class="docutils literal notranslate"><span class="pre">Pytest</span></code> <code class="docutils literal notranslate"><span class="pre">--backend</span></code> argument, and a fixture to
access it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">def</span> <span class="nf">pytest_addoption</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
<span class="linenos">2</span>    <span class="n">parser</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span><span class="s2">&quot;--backend&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;speculos&quot;</span><span class="p">)</span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="nd">@fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="linenos">5</span><span class="k">def</span> <span class="nf">backend_name</span><span class="p">(</span><span class="n">pytestconfig</span><span class="p">):</span>
<span class="linenos">6</span>    <span class="k">return</span> <span class="n">pytestconfig</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;backend&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now that we are able to now wich backend is chosen, we can write a function
returning the correct backend:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">ragger.backend</span> <span class="kn">import</span> <span class="n">LedgerCommBackend</span><span class="p">,</span> <span class="n">LedgerWalletBackend</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="n">BACKENDS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;speculos&quot;</span><span class="p">,</span> <span class="s2">&quot;ledgercomm&quot;</span><span class="p">,</span> <span class="s2">&quot;ledgerwallet&quot;</span><span class="p">]</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">def</span> <span class="nf">create_backend</span><span class="p">(</span><span class="n">backend_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">firmware</span><span class="p">:</span> <span class="n">Firmware</span><span class="p">,</span> <span class="n">display</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BackendInterface</span><span class="p">:</span>
<span class="linenos"> 6</span>    <span class="k">if</span> <span class="n">backend</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ledgercomm&quot;</span><span class="p">:</span>
<span class="linenos"> 7</span>        <span class="k">return</span> <span class="n">LedgerCommBackend</span><span class="p">(</span><span class="n">firmware</span><span class="p">,</span> <span class="n">interface</span><span class="o">=</span><span class="s2">&quot;hid&quot;</span><span class="p">)</span>
<span class="linenos"> 8</span>    <span class="k">elif</span> <span class="n">backend</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ledgerwallet&quot;</span><span class="p">:</span>
<span class="linenos"> 9</span>        <span class="k">return</span> <span class="n">LedgerWalletBackend</span><span class="p">(</span><span class="n">firmware</span><span class="p">)</span>
<span class="linenos">10</span>    <span class="k">elif</span> <span class="n">backend</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;speculos&quot;</span><span class="p">:</span>
<span class="linenos">11</span>        <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">prepare_speculos_args</span><span class="p">(</span><span class="n">firmware</span><span class="p">,</span> <span class="n">display</span><span class="p">)</span>
<span class="linenos">12</span>        <span class="k">return</span> <span class="n">SpeculosBackend</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">firmware</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">13</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">14</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Backend &#39;</span><span class="si">{</span><span class="n">backend</span><span class="si">}</span><span class="s2">&#39; is unknown. Valid backends are: </span><span class="si">{</span><span class="n">BACKENDS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Test can now be launched to run with another backend:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="c1"># start the application on a physical device connected to the computer, or on an emulator</span>
$<span class="w"> </span>pytest<span class="w"> </span>-v<span class="w"> </span>--backend<span class="w"> </span>ledgercomm<span class="w"> </span>test_something.py
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This won’t work - again - because the tests will run for every SDK versions, but
the application currently started could only be of one SDK version!</p>
</div>
<p>We can allow <code class="docutils literal notranslate"><span class="pre">Pytest</span></code> to specify the firmware by expanding/modifying our current code:</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">conftest.py</span><a class="headerlink" href="#id5" title="Permalink to this code"></a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">pytest</span> <span class="kn">import</span> <span class="n">fixture</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kn">from</span> <span class="nn">ragger.firmware</span> <span class="kn">import</span> <span class="n">Firmware</span>
<span class="linenos"> 5</span><span class="kn">from</span> <span class="nn">ragger.backend</span> <span class="kn">import</span> <span class="n">SpeculosBackend</span><span class="p">,</span> <span class="n">LedgerCommBackend</span><span class="p">,</span> <span class="n">LedgerWalletBackend</span><span class="p">,</span> <span class="n">BackendInterface</span>
<span class="linenos"> 6</span><span class="kn">from</span> <span class="nn">ragger.utils</span> <span class="kn">import</span> <span class="n">app_path_from_app_name</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="n">APPS_DIRECTORY</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;path/to/&quot;</span><span class="p">)</span>
<span class="linenos"> 9</span><span class="n">APP_NAME</span> <span class="o">=</span> <span class="s2">&quot;app&quot;</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="n">FIRMWARES</span> <span class="o">=</span> <span class="p">[</span><span class="n">Firmware</span><span class="p">(</span><span class="s1">&#39;nanos&#39;</span><span class="p">,</span> <span class="s1">&#39;2.1&#39;</span><span class="p">),</span>
<span class="linenos">12</span>             <span class="n">Firmware</span><span class="p">(</span><span class="s1">&#39;nanox&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.2&#39;</span><span class="p">),</span>
<span class="linenos">13</span>            <span class="n">Firmware</span><span class="p">(</span><span class="s1">&#39;nanosp&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.3&#39;</span><span class="p">)]</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="n">BACKENDS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;speculos&quot;</span><span class="p">,</span> <span class="s2">&quot;ledgercomm&quot;</span><span class="p">,</span> <span class="s2">&quot;ledgerwallet&quot;</span><span class="p">]</span>
<span class="linenos">16</span>
<span class="linenos">17</span><span class="k">def</span> <span class="nf">pytest_addoption</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
<span class="linenos">18</span>    <span class="n">parser</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span><span class="s2">&quot;--backend&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;speculos&quot;</span><span class="p">)</span>
<span class="linenos">19</span>    <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">FIRMWARES</span><span class="p">:</span>
<span class="linenos">20</span>        <span class="n">parser</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="o">+</span><span class="n">fw</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;run on </span><span class="si">{</span><span class="n">fw</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2"> only&quot;</span><span class="p">)</span>
<span class="linenos">21</span>
<span class="linenos">22</span><span class="nd">@fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="linenos">23</span><span class="k">def</span> <span class="nf">backend_name</span><span class="p">(</span><span class="n">pytestconfig</span><span class="p">):</span>
<span class="linenos">24</span>    <span class="k">return</span> <span class="n">pytestconfig</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;backend&quot;</span><span class="p">)</span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="k">def</span> <span class="nf">create_backend</span><span class="p">(</span><span class="n">backend_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">firmware</span><span class="p">:</span> <span class="n">Firmware</span><span class="p">,</span> <span class="n">display</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BackendInterface</span><span class="p">:</span>
<span class="linenos">27</span>    <span class="k">if</span> <span class="n">backend</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ledgercomm&quot;</span><span class="p">:</span>
<span class="linenos">28</span>        <span class="k">return</span> <span class="n">LedgerCommBackend</span><span class="p">(</span><span class="n">firmware</span><span class="p">,</span> <span class="n">interface</span><span class="o">=</span><span class="s2">&quot;hid&quot;</span><span class="p">)</span>
<span class="linenos">29</span>    <span class="k">elif</span> <span class="n">backend</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ledgerwallet&quot;</span><span class="p">:</span>
<span class="linenos">30</span>        <span class="k">return</span> <span class="n">LedgerWalletBackend</span><span class="p">(</span><span class="n">firmware</span><span class="p">)</span>
<span class="linenos">31</span>    <span class="k">elif</span> <span class="n">backend</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;speculos&quot;</span><span class="p">:</span>
<span class="linenos">32</span>        <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">prepare_speculos_args</span><span class="p">(</span><span class="n">firmware</span><span class="p">,</span> <span class="n">display</span><span class="p">)</span>
<span class="linenos">33</span>        <span class="k">return</span> <span class="n">SpeculosBackend</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">firmware</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">34</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">35</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Backend &#39;</span><span class="si">{</span><span class="n">backend</span><span class="si">}</span><span class="s2">&#39; is unknown. Valid backends are: </span><span class="si">{</span><span class="n">BACKENDS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">36</span>
<span class="linenos">37</span><span class="k">def</span> <span class="nf">pytest_generate_tests</span><span class="p">(</span><span class="n">metafunc</span><span class="p">):</span>
<span class="linenos">38</span>    <span class="k">if</span> <span class="s2">&quot;firmware&quot;</span> <span class="ow">in</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">fixturenames</span><span class="p">:</span>
<span class="linenos">39</span>        <span class="n">fw_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">40</span>        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">41</span>        <span class="c1"># First pass: enable only demanded firmwares</span>
<span class="linenos">42</span>        <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">FIRMWARES</span><span class="p">:</span>
<span class="linenos">43</span>            <span class="k">if</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="n">fw</span><span class="o">.</span><span class="n">device</span><span class="p">):</span>
<span class="linenos">44</span>                <span class="n">fw_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>
<span class="linenos">45</span>                <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw</span><span class="o">.</span><span class="n">device</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">fw</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
<span class="linenos">46</span>        <span class="c1"># Second pass if no specific firmware demanded: add them all</span>
<span class="linenos">47</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">fw_list</span><span class="p">:</span>
<span class="linenos">48</span>            <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">FIRMWARES</span><span class="p">:</span>
<span class="linenos">49</span>                <span class="n">fw_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>
<span class="linenos">50</span>                <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw</span><span class="o">.</span><span class="n">device</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">fw</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
<span class="linenos">51</span>        <span class="n">metafunc</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;firmware&quot;</span><span class="p">,</span> <span class="n">fw_list</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">)</span>
<span class="linenos">52</span>
<span class="linenos">53</span><span class="nd">@fixture</span>
<span class="linenos">54</span><span class="k">def</span> <span class="nf">backend</span><span class="p">(</span><span class="n">firmware</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpeculosBackend</span><span class="p">:</span>
<span class="linenos">55</span>    <span class="n">app_location</span> <span class="o">=</span> <span class="n">app_path_from_app_name</span><span class="p">(</span><span class="n">APPS_DIRECTORY</span><span class="p">,</span> <span class="n">APP_NAME</span><span class="p">,</span> <span class="n">firmware</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="linenos">56</span>    <span class="n">backend</span> <span class="o">=</span> <span class="n">SpeculosBackend</span><span class="p">(</span><span class="n">app_location</span><span class="p">,</span> <span class="n">firmware</span><span class="p">)</span>
<span class="linenos">57</span>    <span class="k">with</span> <span class="n">backend</span><span class="p">:</span>
<span class="linenos">58</span>        <span class="k">yield</span> <span class="n">backend</span>
</pre></div>
</div>
</div>
<p>And now we can easily specify which firmware should be used:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="c1"># start the application on a physical device connected to the computer, or on an emulator</span>
$<span class="w"> </span>pytest<span class="w"> </span>-v<span class="w"> </span>--nanosp<span class="w"> </span>--backend<span class="w"> </span>ledgercomm<span class="w"> </span>test_something.py

<span class="o">===============================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">===============================</span>
collected<span class="w"> </span><span class="m">1</span><span class="w"> </span>items

test_something.py::test_something<span class="o">[</span>nanosp<span class="w"> </span><span class="m">1</span>.0.3<span class="o">]</span><span class="w"> </span>PASSED<span class="w">                       </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">================================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.22s<span class="w"> </span><span class="o">================================</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="abstracting-the-interactions">
<h2>Abstracting the interactions<a class="headerlink" href="#abstracting-the-interactions" title="Permalink to this heading"></a></h2>
<p>Interacting programmatically with an application tends to be a non-trivial
thing, as complex processes (like performing a complete transaction) have to be
implemented through low-level actions on the device: forging bytes payloads (the
<a class="reference internal" href="glossary.html#term-APDU"><span class="xref std std-term">APDUs</span></a>), triggering the buttons or the screen at the right time,
in the right places, in the right order, managing several screens, …</p>
<div class="section" id="fatstacks">
<h3>Fatstacks<a class="headerlink" href="#fatstacks" title="Permalink to this heading"></a></h3>
<p>Interacting with the Fatstacks screen, in particular, can be bothersome. It is
hard to keep track of button positions, pages layouts and such.</p>
<p>For instance let’s imagine you develop an application with a welcome screen
with the application icon in the center, a “quit” clickable button on the
top right and a “info” clickable button on the lower center.</p>
<p>If you click on the “quit” button, well the application shuts down.</p>
<p>If you click on the “info” button the screen shows some application infos, with
a clickable “return” button on the lower center, which brings back to the
previous, welcome screen.</p>
<a class=""
               data-lightbox="group-fatstack_base_group"
               href="_images/fatstacks_welcome.png"
               title=""
               data-title=""
               
               ><img src="_images/fatstacks_welcome.png"
                     class=""
                     width="30%"
                     height="auto"
                     alt=""/>
                </a><a class=""
               data-lightbox="group-fatstack_base_group"
               href="_images/fatstacks_infos.png"
               title=""
               data-title=""
               
               ><img src="_images/fatstacks_infos.png"
                     class=""
                     width="30%"
                     height="auto"
                     alt=""/>
                </a><p>This layouts has three clickable buttons. Basic interaction with them would be
something like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="c1"># going into the &quot;info&quot; screen</span>
<span class="linenos">2</span><span class="n">backend</span><span class="o">.</span><span class="n">touch_finger</span><span class="p">(</span><span class="mi">197</span><span class="p">,</span> <span class="mi">606</span><span class="p">)</span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="c1"># going back into the &quot;welcome&quot; screen</span>
<span class="linenos">5</span><span class="n">backend</span><span class="o">.</span><span class="n">touch_finger</span><span class="p">(</span><span class="mi">197</span><span class="p">,</span> <span class="mi">606</span><span class="p">)</span>
<span class="linenos">6</span>
<span class="linenos">7</span><span class="c1"># quitting the application</span>
<span class="linenos">8</span><span class="n">backend</span><span class="o">.</span><span class="n">touch_finger</span><span class="p">(</span><span class="mi">342</span><span class="p">,</span> <span class="mi">55</span><span class="p">)</span>
</pre></div>
</div>
<p>This does not look very complicated. However, this is just obfuscated code.
Without extended comment, you can’t ask someone to understand or remember what
this code does. This is a guaranteed path to hard to maintain code.</p>
<p>Moreover, these pixel positions are not guaranteed to last. If the SDK chooses
to change some button position, or if higher-level graphic objects (such as
<code class="docutils literal notranslate"><span class="pre">Pages</span></code> or <code class="docutils literal notranslate"><span class="pre">UseCase</span></code>) changes the position (nothing prevents them to move
the “quit” button to the top left), all this code becomes deprecated.</p>
<p>That’s why <code class="docutils literal notranslate"><span class="pre">Ragger</span></code> mimics the Fatstacks SDK graphics library and provides
<a class="reference internal" href="glossary.html#term-Layout"><span class="xref std std-term">Layout</span></a> and <a class="reference internal" href="glossary.html#term-Use-Case"><span class="xref std std-term">Use Case</span></a> (<a class="reference internal" href="glossary.html#term-Page"><span class="xref std std-term">Page</span></a> will also come soon) classes
that keep track of every interactive screen elements and expose meaningful
method to interact with them.</p>
<div class="section" id="layouts">
<h4>Layouts<a class="headerlink" href="#layouts" title="Permalink to this heading"></a></h4>
<p><code class="docutils literal notranslate"><span class="pre">Ragger</span></code>’s <code class="xref py py-class docutils literal notranslate"><span class="pre">Layouts</span></code> and
<code class="xref py py-class docutils literal notranslate"><span class="pre">UseCases</span></code> allows to
quickly describe an application screens and its attached behavior in a purely
declarative way, thanks to the
<a class="reference internal" href="source.html#ragger.firmware.fatstacks.screen.MetaScreen" title="ragger.firmware.fatstacks.screen.MetaScreen"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaScreen</span></code></a> metaclass.
For instance, with the previously described application:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kn">from</span> <span class="nn">ragger.firmware.fatstacks.screen</span> <span class="kn">import</span> <span class="n">MetaScreen</span>
<span class="linenos">2</span><span class="kn">from</span> <span class="nn">ragger.firmware.fatstacks.layouts</span> <span class="kn">import</span> <span class="n">ExitFooter</span><span class="p">,</span> <span class="n">ExitHeader</span><span class="p">,</span> <span class="n">InfoFooter</span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="k">class</span> <span class="nc">RecoveryAppScreen</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">MetaScreen</span><span class="p">)</span>
<span class="linenos">5</span>    <span class="n">layout_quit</span> <span class="o">=</span> <span class="n">ExitHeader</span>
<span class="linenos">6</span>    <span class="n">layout_go_to_info_page</span> <span class="o">=</span> <span class="n">InfoFooter</span>
<span class="linenos">7</span>    <span class="n">layout_return_to_welcome_page</span> <span class="o">=</span> <span class="n">ExitFooter</span>
</pre></div>
</div>
<p>The metaclass will automatically detect all variables starting with <code class="docutils literal notranslate"><span class="pre">layout_</span></code>
and create related attributes when the <code class="docutils literal notranslate"><span class="pre">RecoveryAppScreen</span></code> will be
instantiated. This latter will need - like a lot of <code class="docutils literal notranslate"><span class="pre">Ragger</span></code> classes - a
<a class="reference internal" href="glossary.html#term-Backend"><span class="xref std std-term">backend</span></a> and a <a class="reference internal" href="glossary.html#term-Firmware"><span class="xref std std-term">firmware</span></a> as arguments.</p>
<p>Once instantiated, the created screen can be interacted with in a more flexible
way than if positions were still necessary:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1"># let&#39;s say we still have a ``backend`` and a ``firmware`` fixture</span>
<span class="linenos"> 2</span><span class="n">screen</span> <span class="o">=</span> <span class="n">RecoveryAppScreen</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">firmware</span><span class="p">)</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="c1"># the application starts on the &quot;welcome&quot; page, from here we can either quit</span>
<span class="linenos"> 5</span><span class="c1"># the application, or go to the &quot;info&quot; page</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="c1"># this method call will trigger a ``finger_touch`` with the positions related</span>
<span class="linenos"> 8</span><span class="c1"># to the &quot;info&quot; centered lower button</span>
<span class="linenos"> 9</span><span class="n">screen</span><span class="o">.</span><span class="n">go_to_info_page</span><span class="o">.</span><span class="n">tap</span><span class="p">()</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="c1"># now the application is on the &quot;info&quot; screen, it can only go back to the</span>
<span class="linenos">12</span><span class="c1"># &quot;welcome&quot; page</span>
<span class="linenos">13</span><span class="n">screen</span><span class="o">.</span><span class="n">return_to_welcome_page</span><span class="o">.</span><span class="n">tap</span><span class="p">()</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="c1"># now the application is back on the &quot;welcome&quot; screen. Let&#39;s quit</span>
<span class="linenos">16</span><span class="n">screen</span><span class="o">.</span><span class="n">quit</span><span class="o">.</span><span class="n">tap</span><span class="p">()</span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="c1"># the application is now stopped</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You may have noticed that the two centered lower buttons (the welcome page
“info” button and the info page “return” button) are exactly at the same
<code class="docutils literal notranslate"><span class="pre">(x,</span> <span class="pre">y)</span></code> positions, so why bother declaring them twice?</p>
<p>First of all, the buttons may be at the same place, but they don’t carry the
same purpose, and it is a good idea to reflect that on the code.</p>
<p>Second, if in a future version the Fatstacks design changes and one of these
button moves somewhere else on the screen’s footer, <strong>the layouts will be
updated accordingly</strong> in <code class="docutils literal notranslate"><span class="pre">Ragger</span></code>, and the <code class="docutils literal notranslate"><span class="pre">InfoFooter</span></code> or <code class="docutils literal notranslate"><span class="pre">ExitFooter</span></code>
will still be valid, hence all code using this class remains valid too.</p>
<p>If these arguments does not convince you, <code class="docutils literal notranslate"><span class="pre">Ragger</span></code> provides purely
positional Layouts, and you can use <code class="docutils literal notranslate"><span class="pre">CenteredFooter</span></code> in replacement of both
of these Layouts.</p>
</div>
</div>
<div class="section" id="use-cases">
<h4>Use cases<a class="headerlink" href="#use-cases" title="Permalink to this heading"></a></h4>
<p>But this is not simple enough <em>yet</em>. The previously shown screens are very
common, so common in fact that the SDK provides dedicated
<a class="reference internal" href="glossary.html#term-Use-Case"><span class="xref std std-term">Use Cases</span></a> to simplify their creation.</p>
<p>In this case, there is two. In the SDK, they are named:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nbgl_useCaseHome</span></code>, which displays the “welcome” page, while allowing to
access an “info” or “settings” page.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nbgl_useCaseSettings</span></code>, which displays an “info” or “settings” page. This
Use Case is very convenient when dealing with multiple info or settings which
need several pages to be displayed (hence needs navigation buttons).</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">Ragger</span></code> replicates these Use Cases, and provides more meaningful methods on
top of them. Using Use Cases is very similar to Layouts; they need to be
declared as attribute of a class using the <code class="xref py py-class docutils literal notranslate"><span class="pre">MetaScreen</span></code> metaclass,
and start with <code class="docutils literal notranslate"><span class="pre">use_case_</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">ragger.firmware.fatstacks.screen</span> <span class="kn">import</span> <span class="n">MetaScreen</span>
<span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">ragger.firmware.fatstacks.use_case</span> <span class="kn">import</span> <span class="n">UseCaseHome</span><span class="p">,</span> <span class="n">UseCaseSettings</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">class</span> <span class="nc">RecoveryAppScreen</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">MetaScreen</span><span class="p">)</span>
<span class="linenos"> 5</span>    <span class="n">use_case_welcome</span> <span class="o">=</span> <span class="n">UseCaseHome</span>
<span class="linenos"> 6</span>    <span class="n">use_case_info</span> <span class="o">=</span> <span class="n">UseCaseSettings</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="c1"># let&#39;s say we still have a ``backend`` and a ``firmware`` fixture</span>
<span class="linenos"> 9</span><span class="n">screen</span> <span class="o">=</span> <span class="n">RecoveryAppScreen</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">firmware</span><span class="p">)</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="c1"># the application starts on the &quot;welcome&quot; page, from here we can either quit</span>
<span class="linenos">12</span><span class="c1"># the application, or go to the &quot;info&quot; page</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="c1"># this method call will trigger a ``finger_touch`` with the positions related</span>
<span class="linenos">15</span><span class="c1"># to the &quot;info&quot; centered lower button</span>
<span class="linenos">16</span><span class="n">screen</span><span class="o">.</span><span class="n">welcome</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
<span class="linenos">17</span>
<span class="linenos">18</span><span class="c1"># now the application is on the &quot;info&quot; screen, it can only go back to the</span>
<span class="linenos">19</span><span class="c1"># &quot;welcome&quot; page.</span>
<span class="linenos">20</span><span class="c1"># if the info needed to be shown on several pages, this Use Case also</span>
<span class="linenos">21</span><span class="c1"># provides navigation methods, ``.next`` and ``.back``</span>
<span class="linenos">22</span><span class="n">screen</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
<span class="linenos">23</span>
<span class="linenos">24</span><span class="c1"># now the application is back on the &quot;welcome&quot; screen. Let&#39;s quit</span>
<span class="linenos">25</span><span class="n">screen</span><span class="o">.</span><span class="n">welcome</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
<span class="linenos">26</span>
<span class="linenos">27</span><span class="c1"># the application is now stopped</span>
</pre></div>
</div>
</div>
<div class="section" id="the-fullscreen-class">
<h4>The <code class="docutils literal notranslate"><span class="pre">FullScreen</span></code> class<a class="headerlink" href="#the-fullscreen-class" title="Permalink to this heading"></a></h4>
<p>All these classes helps you tailoring a fairly elegant and straight-forward
client with meaningful and easy to write screen controls. However if you don’t
feel like crafting you own screen representation, <code class="docutils literal notranslate"><span class="pre">Ragger</span></code> comes with a
<a class="reference internal" href="source.html#ragger.firmware.fatstacks.screen.FullScreen" title="ragger.firmware.fatstacks.screen.FullScreen"><code class="xref py py-class docutils literal notranslate"><span class="pre">FullScreen</span></code></a> class
which embeds every existing <a class="reference internal" href="glossary.html#term-Layout"><span class="xref std std-term">Layout</span></a> and <a class="reference internal" href="glossary.html#term-Use-Case"><span class="xref std std-term">Use Case</span></a>.</p>
<p>It can be used to quickly instantiate a screen which could work with any
application screen, however of course, all action on this class are not
guaranteed to trigger a desired reaction (or no reaction at all) on the
application screen, as declared button can be totally fictional.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">ragger.firmware.fatstacks.screen</span> <span class="kn">import</span> <span class="n">FullScreen</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="n">screen</span> <span class="o">=</span> <span class="n">FullScreen</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">firmware</span><span class="p">)</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="c1"># these use case methods will work in our case</span>
<span class="linenos"> 6</span><span class="n">screen</span><span class="o">.</span><span class="n">home</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
<span class="linenos"> 7</span><span class="n">screen</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
<span class="linenos"> 8</span><span class="n">screen</span><span class="o">.</span><span class="n">welcome</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="c1"># layouts are also available, on these method will work too</span>
<span class="linenos">11</span><span class="n">screen</span><span class="o">.</span><span class="n">info_footer</span><span class="o">.</span><span class="n">tap</span><span class="p">()</span>
<span class="linenos">12</span><span class="n">screen</span><span class="o">.</span><span class="n">exit_footer</span><span class="o">.</span><span class="n">tap</span><span class="p">()</span>
<span class="linenos">13</span><span class="n">screen</span><span class="o">.</span><span class="n">exit_header</span><span class="o">.</span><span class="n">tap</span><span class="p">()</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="c1"># this, however, will just randomly click on the screen and may or may not</span>
<span class="linenos">16</span><span class="c1"># trigger totally unrelated reaction</span>
<span class="linenos">17</span><span class="n">screen</span><span class="o">.</span><span class="n">letter_only_keyboard</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;hello world!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="rationale.html" class="btn btn-neutral float-left" title="Rationale" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="architecture.html" class="btn btn-neutral float-right" title="Architecture" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, bow.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>